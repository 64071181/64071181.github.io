<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È≠îÈè°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {margin: 0;padding: 0;box-sizing: border-box; }
        
        body {font-family: 'Noto Serif TC', serif;background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);min-height: 100vh;display: flex;flex-direction: column;align-items: center;padding: 20px;color: #d4af37;position: relative;overflow-x: hidden; }
        

        body::before {content: "";position: absolute;top: 0;left: 0;right: 0;bottom: 0;background: 
                radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 20%);z-index: -1; }
        
        a{text-decoration: none;}
        .container {max-width: 900px;width: 100%;display: flex;flex-direction: column;align-items: center;gap: 25px;position: relative;z-index: 10; }
        
        .header {text-align: center;margin-top: 15px;position: relative;width: 100%;padding: 30px 0; }
        
        .title {font-family: 'Noto Serif TC', serif;font-weight: 900;font-size: 4.8rem;background: linear-gradient(to right, #d4af37, #f9f295, #ffffff, #f9f295, #d4af37);-webkit-background-clip: text;-webkit-text-fill-color: transparent;text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);margin-bottom: 15px;position: relative;display: inline-block;letter-spacing: 5px; }
        
        .title::after {content: "‚ú®";position: absolute;top: -30px;right: -50px;font-size: 3rem;animation: sparkle 2s infinite;color: #f9f295;filter: drop-shadow(0 0 10px gold); }
        
        .title::before {content: "üíé";position: absolute;top: -20px;left: -50px;font-size: 2.5rem;animation: sparkle 3s infinite 0.5s;color: #c0c0c0;filter: drop-shadow(0 0 10px silver); }
        
        .subtitle {font-size: 1.6rem;color: #e0e0e0;margin-bottom: 25px;letter-spacing: 3px;text-shadow: 0 0 15px rgba(255, 255, 255, 0.4);font-weight: 400;position: relative; }
        
        .subtitle::after {content: "";display: block;width: 120px;height: 3px;background: linear-gradient(to right, transparent, #d4af37, #c0c0c0, #d4af37, transparent);margin: 15px auto 0;border-radius: 50%; }
        
        .main-content {display: flex;flex-direction: column;align-items: center;gap: 30px;width: 100%; }
        
        .camera-photo-container {position: relative;width: 100%;max-width: 500px;margin: 0 auto;border-radius: 20px;overflow: hidden;box-shadow: 
                0 0 40px rgba(212, 175, 55, 0.5),
                0 0 80px rgba(192, 192, 192, 0.3),
                inset 0 0 30px rgba(0, 0, 0, 0.8);background: rgba(15, 12, 41, 0.6);backdrop-filter: blur(12px);aspect-ratio: 3/4;border: 3px solid transparent;background-clip: padding-box; }
        
        .camera-photo-container::before {content: "";position: absolute;top: -3px; left: -3px; right: -3px; bottom: -3px;background: linear-gradient(45deg, #d4af37, #c0c0c0, #d4af37, #f9f295, #d4af37);border-radius: 20px;z-index: -1;animation: borderAnimation 6s infinite linear; }
        
        #video {width: 100%;height: 100%;display: block;object-fit: cover;background: linear-gradient(135deg, #1a162f, #0f0c29);transform: scaleX(-1); }
        
        #photoCanvas {position: absolute;top: 0;left: 0;width: 100%;height: 100%;display: none;object-fit: cover;background: linear-gradient(135deg, #1a162f, #0f0c29); }
        
        .camera-icon {position: absolute;bottom: 25px;left: 50%;transform: translateX(-50%);width: 80px;height: 80px;background: radial-gradient(circle, #d4af37, #8d6e0d);border-radius: 50%;display: flex;align-items: center;justify-content: center;box-shadow: 0 0 30px rgba(212, 175, 55, 0.9);cursor: pointer;z-index: 20;border: 3px solid #f9f295;transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .camera-icon:hover {transform: translateX(-50%) scale(1.15);box-shadow: 0 0 45px rgba(212, 175, 55, 1); }
        
        .camera-icon i {font-size: 36px;color: #fff;text-shadow: 0 0 8px rgba(0, 0, 0, 0.7); }
        
        .controls {display: flex;justify-content: center;gap: 25px;margin-top: 25px;width: 100%; }
        
        .btn {padding: 16px 35px;border: none;border-radius: 60px;font-family: 'Noto Serif TC', serif;font-weight: 700;font-size: 1.5rem;cursor: pointer;transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);display: flex;align-items: center;gap: 12px;box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);position: relative;overflow: hidden;z-index: 1;letter-spacing: 2px; }
        
        .btn::before {content: '';position: absolute;top: 0;left: 0;width: 100%;height: 100%;background: linear-gradient(45deg, #d4af37, #c0c0c0, #d4af37);z-index: -1;opacity: 0.9; }
        
        .btn::after {content: '';position: absolute;top: 3px;left: 3px;right: 3px;bottom: 3px;background: linear-gradient(135deg, #0f0c29, #302b63);border-radius: 60px;z-index: -1; }
        
        .btn span {color: #f9f295;text-shadow: 0 0 8px rgba(212, 175, 55, 0.7);position: relative;z-index: 2;font-weight: 700; }
        
        .btn i {color: #ffffff;text-shadow: 0 0 8px rgba(255, 255, 255, 0.7);position: relative;z-index: 2;font-size: 1.8rem; }
        
        .btn:active {transform: translateY(5px);box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4); }
        
        /* ÁªìÊûúÂå∫Âüü */
        .results {background: rgba(15, 12, 41, 0.7);border-radius: 25px;padding: 30px;width: 100%;max-width: 600px;text-align: center;box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.7),
                inset 0 0 25px rgba(212, 175, 55, 0.4);backdrop-filter: blur(10px);border: 2px solid rgba(212, 175, 55, 0.4);position: relative; }
        
        .results::before {content: "";position: absolute;top: 0;left: 0;right: 0;height: 5px;background: linear-gradient(to right, transparent, #d4af37, #c0c0c0, #d4af37, transparent);border-radius: 5px; }
        
        .result-item {margin: 25px 0;padding: 20px;border-radius: 20px;background: rgba(30, 26, 60, 0.5);position: relative;overflow: hidden; }
        
        .result-item h3 {color: #f9f295;font-size: 2.1rem;margin-bottom: 20px;text-shadow: 0 0 15px rgba(249, 242, 149, 0.5);font-weight: 700;letter-spacing: 3px; }
        
        .message {font-size: 2rem;color: #ffffff;line-height: 1.6;min-height: 100px;display: flex;align-items: center;justify-content: center;padding: 15px;text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);font-weight: 400;letter-spacing: 1px; }
        
        /* È°∂ÈÉ®‰ø°ÊÅØÊ†è */
        .top-info-bar {position: absolute;top: 25px;left: 0;right: 0;display: flex;justify-content: space-between;padding: 0 25px;z-index: 30; }
        
        /* ÁÇπÊï∞ÊåâÈíÆÊ†∑Âºè */
        .points-btn {background: rgba(15, 12, 41, 0.8);border: 2px solid rgba(212, 175, 55, 0.6);color: #f9f295;font-size: 1.3rem;cursor: pointer;display: flex;align-items: center;gap: 8px;padding: 10px 20px;border-radius: 30px;transition: all 0.4s;font-family: 'Noto Serif TC', serif;font-weight: 700;box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);backdrop-filter: blur(8px);letter-spacing: 1px; }
        
        .points-btn:hover {background: rgba(212, 175, 55, 0.3);box-shadow: 0 0 25px rgba(212, 175, 55, 0.6);transform: translateY(-3px); }
        
        .points-btn:active {transform: translateY(1px); }
        
        .points-value {font-size: 2rem;font-weight: 900;color: #ffffff;font-family: 'Noto Serif TC', serif;margin-left: 8px;text-shadow: 0 0 15px rgba(249, 242, 149, 0.7); }
        
        /* ËØÑÂàÜÊòæÁ§∫Ê†∑Âºè */
        .score-display {background: rgba(15, 12, 41, 0.8);border: 2px solid rgba(192, 192, 192, 0.6);color: #ffffff;font-size: 1.3rem;display: flex;align-items: center;gap: 8px;padding: 10px 20px;border-radius: 30px;font-family: 'Noto Serif TC', serif;font-weight: 700;box-shadow: 0 0 15px rgba(192, 192, 192, 0.3);backdrop-filter: blur(8px);letter-spacing: 1px; }
        
        .score-value {font-size: 2.5rem;font-weight: 900;color: #f9f295;font-family: 'Noto Serif TC', serif;margin-left: 8px;text-shadow: 0 0 15px rgba(249, 242, 149, 0.7); }
        
        .gem-icon {color: #f9f295;margin-right: 8px;font-size: 1.6rem;text-shadow: 0 0 8px rgba(249, 242, 149, 0.7); }
        
        .footer {margin-top: 30px;text-align: center;color: #c0c0c0;font-size: 1.2rem;padding: 25px;background: rgba(15, 12, 41, 0.6);border-radius: 20px;width: 100%;max-width: 650px;box-shadow: inset 0 0 15px rgba(212, 175, 55, 0.3);border: 2px solid rgba(212, 175, 55, 0.2);letter-spacing: 1px;line-height: 1.8; }
        
        /* Ë£ÖÈ•∞ÂÖÉÁ¥† */
        .decoration {position: absolute;z-index: 1;opacity: 0.7;pointer-events: none; }
        
        .decoration.diamond {width: 90px;height: 90px;background: radial-gradient(circle, #fff, #c0c0c0);clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);top: 10%;left: 5%;animation: float 8s infinite ease-in-out;box-shadow: 0 0 30px rgba(192, 192, 192, 0.7);filter: blur(1px); }
        
        .decoration.gold-bar {width: 220px;height: 10px;background: linear-gradient(90deg, #d4af37, #f9f295, #d4af37);bottom: 15%;right: 5%;border-radius: 5px;animation: shine 3s infinite;box-shadow: 0 0 20px rgba(212, 175, 55, 0.7); }
        
        .decoration.silver-circle {width: 70px;height: 70px;border: 4px solid #c0c0c0;border-radius: 50%;bottom: 25%;left: 8%;box-shadow: 0 0 20px rgba(192, 192, 192, 0.7);animation: pulse 4s infinite; }
        
        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (min-width: 768px) {.title {    font-size: 5.5rem;}
            
            .subtitle {    font-size: 1.8rem;}
            
            .main-content {    flex-direction: row;    align-items: flex-start;    justify-content: center;}
            
            .results {    max-width: 380px;    margin-top: 40px;}
        }
        
        /* Âä®Áîª */
        @keyframes sparkle {0% { opacity: 0.3; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0.3; transform: scale(0.9); }
        }
        
        @keyframes fadeIn {from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {0% { transform: scale(1); box-shadow: 0 0 15px rgba(212, 175, 55, 0.7); }
            50% { transform: scale(1.08); box-shadow: 0 0 35px rgba(212, 175, 55, 1); }
            100% { transform: scale(1); box-shadow: 0 0 15px rgba(212, 175, 55, 0.7); }
        }
        
        @keyframes float {0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-25px) rotate(15deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }
        
        @keyframes shine {0% { background-position: -150px; }
            100% { background-position: 250px; }
        }
        
        @keyframes borderAnimation {0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .fade-in {animation: fadeIn 0.8s ease forwards; }
        
        .pulse {animation: pulse 2s infinite; }
        
        /* ÈáçÁΩÆÊåâÈíÆÂä®Áîª */
        @keyframes resetAnimation {0% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
            100% { transform: rotate(360deg); }
        }
        
        .reset-animation {animation: resetAnimation 0.8s ease; }
        
        /* ‰∏ãËΩΩÊåâÈíÆÂä®Áîª */
        @keyframes downloadAnimation {
            0% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }
        
        .download-animation {
            animation: downloadAnimation 0.8s ease;
        }
    </style>
</head>
<body>
    <!-- Ë£ÖÈ•∞ÂÖÉÁ¥† -->
    <div class="decoration diamond"></div>
    <div class="decoration gold-bar"></div>
    <div class="decoration silver-circle"></div>
    
    <div class="container">
        <div class="header">
            <h1 class="title">È≠îÈè°</h1>
            <p id="messageDisplay" class="subtitle">ÁíÄÁí®ÂÆπÈ°è ¬∑ Ê•µËá¥Ë©ïÈëë</p>
        </div>
        
        <div class="main-content">
            <div class="camera-photo-container">
                <!-- È°∂ÈÉ®‰ø°ÊÅØÊ†è - Â∑¶‰∏äËßíÁÇπÊï∞ÊåâÈíÆÔºåÂè≥‰∏äËßíËØÑÂàÜ -->
                <div class="top-info-bar">
                    <!-- Â∑¶‰∏äËßíÁÇπÊï∞ÊåâÈíÆ -->
                    <a href="https://64071181.github.io/PayAki/" class="points-btn" id="pointsBtn">
                        <i class="fas fa-gem gem-icon"></i>
                        <span class="points-value" id="pointsDisplay">10</span>
                    </a>
                    
                    <!-- Âè≥‰∏äËßíËØÑÂàÜÊòæÁ§∫ -->
                    <div class="score-display" id="scoreDisplay" style="display: none;">
                        Ë©ïÂàÜ <span class="score-value">--</span>
                    </div>
                </div>
                
                <video id="video" autoplay playsinline></video>
                <canvas id="photoCanvas"></canvas>
                <div class="camera-icon" id="captureBtn">
                    <i class="fas fa-camera"></i>
                </div>
            </div>
            
            <div class="controls">
                <button id="retakeBtn" class="btn" style="display:none;">
                    <i class="fas fa-redo"></i> 
                    <span>ÈáçÊñ∞ÊãçÊîù</span>
                </button>
                
                <!-- Êñ∞Â¢û‰∏ãËΩΩÊåâÈíÆ -->
                <button id="downloadBtn" class="btn" style="display:none;">
                    <i class="fas fa-download"></i> 
                    <span>‰∏ãËºâÂúñÁâá</span>
                </button>
            </div>
            
        </div>
        
        <div class="footer">
            <p>È≠îÈè°:ÁúüÂØ¶È≠ÖÂäõÊ∫êÊñºËá™‰ø°ËàáÊ∞£Ë≥™</p>
        </div>
    </div>
    
<!-- üîê ÁôªÂÖ•ÂçÄÂüü -->
<div id="authSection" style="margin-bottom: 1em;">
  <button id="loginBtn">üîë ‰ΩøÁî® Google ÁôªÂÖ•</button>
  <button id="logoutBtn" style="display:none;">üö™ ÁôªÂá∫</button>
  <span id="userInfo" style="margin-left: 1em;"></span>
</div>















<script type="module">

// ‚úÖ ÂàùÂßãÂåñ Firebase SDK
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js"; // ÂèØÈÅ∏ÊìáÂä†ÂÖ•

// ‚úÖ ‰Ω†ÁöÑ Firebase Ë®≠ÂÆö
const firebaseConfig = {
  apiKey: "AIzaSyCya-DU6OYnWMuHrlvOALODnM8vmsR38F0",
  authDomain: "magicmirror0727.firebaseapp.com",
  projectId: "magicmirror0727",
  storageBucket: "magicmirror0727.appspot.com", // ‰øÆÊ≠£ÈåØË™§ÊãºÂØ´Ôºöfirebasestorage.app ‚Üí firebaseapp.com
  messagingSenderId: "895096216153",
  appId: "1:895096216153:web:434aa6633de30ad124ef48",
  measurementId: "G-JL07EBT0SJ"
};

// ‚úÖ ÂàùÂßãÂåñ Firebase App
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const analytics = getAnalytics(app); // ÂèØÁúÅÁï•


import { GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// ÂèñÂæóÊåâÈàïÂíåÈ°ØÁ§∫ÂçÄ
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userInfo = document.getElementById("userInfo");

// ÂàùÂßãÂåñ provider
const provider = new GoogleAuthProvider();

// ÁôªÂÖ•ÊåâÈàï‰∫ã‰ª∂
loginBtn.addEventListener('click', async () => {
  try {
    await signInWithPopup(auth, provider);
  } catch (error) {
    alert("ÁôªÂÖ•Â§±ÊïóÔºö" + error.message);
  }
});

// ÁôªÂá∫ÊåâÈàï‰∫ã‰ª∂
logoutBtn.addEventListener('click', async () => {
  await signOut(auth);
});

// Áõ£ËÅΩÁôªÂÖ•ÁãÄÊÖãËÆäÂåñ
onAuthStateChanged(auth, async (user) => {
  if (user) {
    // ‚úÖ Â∑≤ÁôªÂÖ•
    loginBtn.style.display = 'none';
    logoutBtn.style.display = 'inline-block';
    userInfo.textContent = `üë§ Â∑≤ÁôªÂÖ•Ôºö${user.email}`;

    // ÂèñÂæó/Âª∫Á´ãÈªûÊï∏Á¥ÄÈåÑ
    const userRef = doc(db, "users", user.uid);
    const docSnap = await getDoc(userRef);

    if (docSnap.exists()) {
      points = docSnap.data().mirrorPoints ?? 10;
    } else {
      await setDoc(userRef, { mirrorPoints: 10 });
      points = 10;
    }

    pointsDisplay.textContent = points;
  } else {
    // ‚ùå Êú™ÁôªÂÖ•
    loginBtn.style.display = 'inline-block';
    logoutBtn.style.display = 'none';
    userInfo.textContent = '';
    pointsDisplay.textContent = "Ë´ãÂÖàÁôªÂÖ•";
  }
});


</script>



    <script>











        document.addEventListener('DOMContentLoaded', function() {
            // Ëé∑ÂèñDOMÂÖÉÁ¥†
            const video = document.getElementById('video');
            const photoCanvas = document.getElementById('photoCanvas');
            const captureBtn = document.getElementById('captureBtn');
            const retakeBtn = document.getElementById('retakeBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const pointsDisplay = document.getElementById('pointsDisplay');
            const messageDisplay = document.getElementById('messageDisplay');
            const pointsBtn = document.getElementById('pointsBtn');
            const scoreValue = document.querySelector('.score-value');
            
            // ÂàùÂßãÂåñÁÇπÊï∞Âíå‰∏ä‰∏ãÊñá
            let points = 0;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userRef = doc(db, "users", user.uid);
                    const userSnap = await getDoc(userRef);

                    if (userSnap.exists()) {
                        points = userSnap.data().mirrorPoints || 10;
                    } else {
                        // È¶ñÊ¨°‰ΩøÁî®ËÄÖÔºåÂª∫Á´ãË≥áÊñô
                        await setDoc(userRef, { mirrorPoints: 10 });
                        points = 10;
                    }
                    pointsDisplay.textContent = points;
                } else {
                    alert("Ë´ãÂÖàÁôªÂÖ•Â∏≥ËôüÊâçËÉΩ‰ΩøÁî®È≠îÈè°ÔºÅ");
                }
            });



            const ctx = photoCanvas.getContext('2d');
            
            // Â≠òÂÇ®ÂΩìÂâçÁÖßÁâá‰ø°ÊÅØ
            let currentPhotoInfo = {
                imageData: null,
                score: null,
                points: points,
                message: ""
            };
            
            // ËØÑËØ≠Êï∞ÁªÑÔºàÂÖ®ÁπÅ‰ΩìÔºâ
            const messages = [
                "ÊÇ®ÁöÑÂÆπÈ°èÂ¶ÇÈëΩÁü≥Ëà¨ÁíÄÁí®ÔºåÁÖß‰∫Æ‰∫ÜÊï¥ÂÄãÊÆøÂ†ÇÔºÅ",
                "Á≤æÁ∑ª‰∫îÂÆòÈÄ£Á∂≠Á¥çÊñØÂ•≥Á•û‰πüË¶ÅÁÇ∫‰πãÂÇæÂÄíÔºÅ",
                "ÈõôÁú∏ÈñÉËÄÄÂ¶ÇÊòüËæ∞ÔºåËòäËóèËëóÁÑ°Áõ°Êô∫ÊÖßÂÖâËäíÔºÅ",
                "ÈÄôËà¨È´òË≤¥Ê∞£Ë≥™ÔºåÂÆöÊòØÂá∫Ëá™ÁöáÂÆ§Ë°ÄËÑàÁÑ°ÁñëÔºÅ",
                "ÂÑ™ÈõÖÈ¢®ÁØÑËÆìÈÄôÈù¢È≠îÈè°ÈÉΩÁÇ∫‰πãËëóËø∑ÂÇæÂøÉÔºÅ",
                "ÂÆåÁæéËº™ÂªìÁå∂Â¶ÇËóùË°ìÂ§ßÂ∏´ÁöÑÂ∑îÂ≥∞ÂÇë‰ΩúÔºÅ",
                "ÊÇ®ÁöÑÂ≠òÂú®ÔºåËÆìÈÄô‰∏ñÁïåËÆäÂæóÊõ¥Âä†Áµ¢È∫óÂ•™ÁõÆÔºÅ",
                "Â¶ÇÊ≠§Áµï‰∏ñÂÆπÈ°èÔºåÂ†™Á®±ÂçÉÂπ¥Èõ£ÈÅáÁöÑÁèçÂØ∂ÔºÅ",
                "ÊÇ®ÁöÑÂæÆÁ¨ëÔºåÂãùÈÅé‰∏ñÈñìÊúÄÁèçË≤¥ÁöÑÂØ∂Áü≥ÂÖâËäíÔºÅ",
                "ÈùûÂá°Ê∞£Ë≥™ÂÆöÊòØÁπÜÊñØÂ•≥Á•ûÁöÑÊúÄÈ´òÊÅ©Ë≥úÔºÅ",
                "È≠îÈè°È≠îÈè°ÂëäË®¥ÊàëÔºåË™∞ÊòØÊúÄÁæéÁöÑ‰∫∫ÔºüÁï∂ÁÑ∂ÊòØÂ∞äË≤¥ÁöÑÊÇ®ÔºÅ",
                "ÊÇ®ÁöÑÁæéË≤åÔºåÈÄ£Â§™ÈôΩÁ•ûÈòøÊ≥¢ÁæÖ‰πüË¶ÅÈªØÁÑ∂Â§±Ëâ≤ÔºÅ",
                "ÈÄôËà¨È´òË≤¥Ê∞£Ë≥™ÔºåÂÆöÊòØÂ•≥Á•ûÈõÖÂÖ∏Â®úËΩâ‰∏ñÈôçËá®ÔºÅ",
                "ÊÇ®ÁöÑÂÆπÈ°èÔºåÊòØÈÄ†Áâ©‰∏ªÊúÄÂÆåÁæéÁöÑËóùË°ìÁµêÊô∂ÔºÅ",
                "Ë∂ÖÂá°ËÑ´‰øóÁöÑÁæéË≤åÔºåÂè™ÊáâÂ≠òÂú®ÊñºÂ§©Áïå‰ªôÂ¢ÉÔºÅ"
            ];
            
            // ËØ∑Ê±ÇÊëÑÂÉèÂ§¥ËÆøÈóÆÊùÉÈôê
            async function initCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'user',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    video.srcObject = stream;
                    
                    // ËÆæÁΩÆcanvasÂ∞∫ÂØ∏‰∏éËßÜÈ¢ëÁõ∏Âêå
                    video.onloadedmetadata = function() {
                        photoCanvas.width = video.videoWidth;
                        photoCanvas.height = video.videoHeight;
                    };
                } catch (err) {
                    console.error("ÁÑ°Ê≥ïË®™ÂïèÊîùÂÉèÈ†≠: ", err);
                    alert("ÁÑ°Ê≥ïË®™ÂïèÊîùÂÉèÈ†≠ÔºåË´ãÁ¢∫‰øùÂ∑≤Êéà‰∫àÊ¨äÈôê‰∏¶ÈáçË©¶„ÄÇ");
                }
            }
            
            // ÊãçÁÖßÂäüËÉΩ
            async function capturePhoto() {
                if (points <= 0) {
                    alert("ÂØ∂Áü≥‰∏çË∂≥ÔºåË´ãÈªûÊìäÂ∑¶‰∏äËßíÂØ∂Áü≥ÂúñÊ®ôÈáçÁΩÆÔºÅ");
                    return;
                }
                
                // Ê∂àËÄóÁÇπÊï∞
                points--;
                pointsDisplay.textContent = points;

                const user = auth.currentUser;
                if (user) {
                    const userRef = doc(db, "users", user.uid);
                    await updateDoc(userRef, { mirrorPoints: points });
                }

                
                // ÁªòÂà∂ÈïúÂÉèÁÖßÁâá
                ctx.save();
                ctx.scale(-1, 1);
                ctx.drawImage(video, -photoCanvas.width, 0, photoCanvas.width, photoCanvas.height);
                ctx.restore();
                
                // ÈöêËóèËßÜÈ¢ëÔºåÊòæÁ§∫ÁîªÂ∏É
                video.style.display = 'none';
                photoCanvas.style.display = 'block';
                captureBtn.style.display = 'none';
                retakeBtn.style.display = 'flex';
                downloadBtn.style.display = 'flex';
                
                // ÁîüÊàêÈöèÊú∫ÂàÜÊï∞ (88-100)
                const score = Math.floor(Math.random() * 13) + 88;
                scoreValue.textContent = score;
                scoreValue.classList.add('pulse');
                
                // ÊòæÁ§∫ËØÑÂàÜ
                scoreDisplay.style.display = 'flex';
                
                // ÈöèÊú∫ÈÄâÊã©ËØÑËØ≠
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                messageDisplay.textContent = randomMessage;
                
                // ‰øùÂ≠òÂΩìÂâçÁÖßÁâá‰ø°ÊÅØ
                currentPhotoInfo = {
                    imageData: photoCanvas.toDataURL('image/png'),
                    score: score,
                    points: points,
                    message: randomMessage
                };
                
                // Ê∑ªÂä†Âä®ÁîªÊïàÊûú
                document.querySelector('.result-item').classList.add('fade-in');
            }
            
            // ÈáçÊñ∞ÊãçÊëÑ
            function retakePhoto() {
                // ÊòæÁ§∫ËßÜÈ¢ëÔºåÈöêËóèÁîªÂ∏É
                video.style.display = 'block';
                photoCanvas.style.display = 'none';
                captureBtn.style.display = 'flex';
                retakeBtn.style.display = 'none';
                downloadBtn.style.display = 'none';
                scoreDisplay.style.display = 'none';
                scoreValue.classList.remove('pulse');
            }
            
            // ‰∏ãËΩΩÂõæÁâá
            function downloadPhoto() {
                if (!currentPhotoInfo.imageData) {
                    alert("Ê≤íÊúâÂèØ‰∏ãËºâÁöÑÁÖßÁâá");
                    return;
                }
                
                // ÂàõÂª∫‰∏¥Êó∂canvasÊù•ÁªòÂà∂Â∏¶Ê∞¥Âç∞ÁöÑÁÖßÁâá
                const downloadCanvas = document.createElement('canvas');
                downloadCanvas.width = photoCanvas.width;
                downloadCanvas.height = photoCanvas.height;
                const downloadCtx = downloadCanvas.getContext('2d');
                
                // ÁªòÂà∂ÂéüÂßãÁÖßÁâá
                const img = new Image();
                img.onload = function() {
                    downloadCtx.drawImage(img, 0, 0, downloadCanvas.width, downloadCanvas.height);
                    
                    // Ê∑ªÂä†Ê∞¥Âç∞ËÉåÊôØ
                    downloadCtx.fillStyle = 'rgba(15, 12, 41, 0.7)';
                    downloadCtx.fillRect(0, downloadCanvas.height - 100, downloadCanvas.width, 100);
                    
                    // Ê∑ªÂä†ËæπÊ°Ü
                    downloadCtx.strokeStyle = '#d4af37';
                    downloadCtx.lineWidth = 3;
                    downloadCtx.strokeRect(0, 0, downloadCanvas.width, downloadCanvas.height);
                    
                    // Ê∑ªÂä†ËØÑÂàÜÂíåÁÇπÊï∞‰ø°ÊÅØ
                    downloadCtx.font = 'bold 40px "Noto Serif TC", serif';
                    downloadCtx.textAlign = 'center';
                    
                    // Ê∑ªÂä†ËØÑÂàÜ
                    downloadCtx.fillStyle = '#f9f295';
                    downloadCtx.shadowColor = 'rgba(249, 242, 149, 0.7)';
                    downloadCtx.shadowBlur = 10;
                    downloadCtx.fillText(`Ë©ïÂàÜ: ${currentPhotoInfo.score}`, downloadCanvas.width / 2, downloadCanvas.height - 60);
                    
                    // Ê∑ªÂä†ÁÇπÊï∞
                    downloadCtx.fillStyle = '#ffffff';
                    downloadCtx.shadowColor = 'rgba(255, 255, 255, 0.7)';
                    downloadCtx.fillText(`ÂØ∂Áü≥: ${currentPhotoInfo.points}`, downloadCanvas.width / 2, downloadCanvas.height - 20);
                    
                    // Ê∑ªÂä†Â∫îÁî®ÂêçÁß∞
                    downloadCtx.fillStyle = '#d4af37';
                    downloadCtx.font = 'bold 30px "Noto Serif TC", serif';
                    downloadCtx.fillText('È≠îÈè°Ë©ïÈëë', downloadCanvas.width / 2, 50);
                    
                    // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                    const link = document.createElement('a');
                    link.download = `È≠îÈè°Ë©ïÈëë_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
                    link.href = downloadCanvas.toDataURL('image/png');
                    link.click();
                    
                    // Ê∑ªÂä†‰∏ãËΩΩÂä®Áîª
                    downloadBtn.classList.add('download-animation');
                    setTimeout(() => {
                        downloadBtn.classList.remove('download-animation');
                    }, 800);
                };
                img.src = currentPhotoInfo.imageData;
            }
            
            // ‰∫ã‰ª∂ÁõëÂê¨
            captureBtn.addEventListener('click', capturePhoto);
            retakeBtn.addEventListener('click', retakePhoto);
            downloadBtn.addEventListener('click', downloadPhoto);
            
            // ÂàùÂßãÂåñ
            initCamera();
        });
    </script>
</body>
</html>